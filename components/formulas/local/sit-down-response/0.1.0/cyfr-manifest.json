{
  "id": "formula:local.sit-down-response",
  "type": "formula",
  "version": "0.1.0",
  "description": "Handles AI member responses in sit-downs: fetches context, builds system prompt, invokes AI catalyst, inserts response",
  "setup": {
    "policy": {
      "allowed_tools": [
        "component.search"
      ],
      "timeout": "3m",
      "max_memory_bytes": 67108864,
      "max_request_size": 1048576,
      "max_response_size": 5242880
    }
  },
  "schema": {
    "input": {
      "type": "object",
      "required": [
        "member_id",
        "sit_down_id",
        "access_token"
      ],
      "properties": {
        "member_id": {
          "type": "string",
          "description": "ID of the AI member to generate a response for"
        },
        "sit_down_id": {
          "type": "string",
          "description": "ID of the sit-down conversation"
        },
        "reply_to_id": {
          "type": "string",
          "description": "Optional message ID this response is replying to"
        },
        "access_token": {
          "type": "string",
          "description": "Supabase access token for RLS-scoped database operations"
        }
      }
    },
    "output": {
      "type": "object",
      "properties": {
        "message_id": {
          "type": "string",
          "description": "ID of the inserted AI response message"
        },
        "content": {
          "type": "string",
          "description": "The AI-generated response text"
        },
        "provider": {
          "type": "string",
          "description": "AI provider used (claude, openai, gemini)"
        },
        "model": {
          "type": "string",
          "description": "Model identifier used"
        }
      }
    }
  },
  "dependencies": {
    "static": [
      {
        "ref": "catalyst:local.supabase:0.2.0",
        "reason": "Database operations: fetch context, insert responses, manage typing indicators"
      }
    ],
    "dynamic": {
      "discovery": "component.search",
      "description": "Discovers AI provider catalyst (Claude, OpenAI, Gemini) at runtime based on the member's configured model provider",
      "typical_types": [
        "catalyst"
      ]
    }
  },
  "examples": [
    {
      "name": "Trigger member response",
      "description": "Generate an AI response for a member in a sit-down",
      "input": {
        "member_id": "abc-123",
        "sit_down_id": "def-456",
        "access_token": "eyJ..."
      },
      "output": {
        "message_id": "ghi-789",
        "content": "Don, if I may offer my counsel...",
        "provider": "claude",
        "model": "claude-sonnet-4-5-20250929"
      }
    },
    {
      "name": "Reply to specific message",
      "description": "Generate a response that's a reply to a particular message",
      "input": {
        "member_id": "abc-123",
        "sit_down_id": "def-456",
        "reply_to_id": "msg-001",
        "access_token": "eyJ..."
      },
      "output": {
        "message_id": "ghi-790",
        "content": "With respect, I see it differently...",
        "provider": "openai",
        "model": "gpt-4o"
      }
    }
  ]
}
