{
  "id": "formula:local.messages-api",
  "type": "formula",
  "version": "0.1.0",
  "description": "Message retrieval with server-side joins (profiles, members, model_catalog) and typing indicator queries",
  "setup": {
    "policy": {
      "timeout": "30s",
      "max_memory_bytes": 67108864,
      "max_request_size": 1048576,
      "max_response_size": 5242880
    }
  },
  "schema": {
    "input": {
      "type": "object",
      "required": ["action", "access_token", "sit_down_id"],
      "properties": {
        "action": {
          "type": "string",
          "enum": ["list", "typing_indicators"],
          "description": "The message operation to perform"
        },
        "access_token": {
          "type": "string",
          "description": "Supabase access token for RLS-scoped operations"
        },
        "sit_down_id": {
          "type": "string",
          "description": "ID of the sit-down conversation"
        }
      }
    },
    "output": {
      "type": "object",
      "properties": {
        "messages": {
          "type": "array",
          "description": "Messages with joined profile, member, and catalog_model data (list action)"
        },
        "typing_indicators": {
          "type": "array",
          "description": "Active typing indicators for the sit-down (typing_indicators action)"
        }
      }
    }
  },
  "dependencies": {
    "static": [
      {
        "ref": "catalyst:local.supabase:0.2.0",
        "reason": "Database operations: message queries with PostgREST joins, typing indicator queries"
      }
    ]
  },
  "examples": [
    {
      "name": "List messages",
      "description": "Fetch all messages for a sit-down with joined profile/member/model data",
      "input": {
        "action": "list",
        "access_token": "eyJ...",
        "sit_down_id": "sd-123"
      },
      "output": {
        "messages": [{"id": "msg-1", "content": "Hello", "profile": {"display_name": "Don"}}]
      }
    },
    {
      "name": "Get typing indicators",
      "description": "Fetch active typing indicators for a sit-down",
      "input": {
        "action": "typing_indicators",
        "access_token": "eyJ...",
        "sit_down_id": "sd-123"
      },
      "output": {
        "typing_indicators": []
      }
    }
  ]
}
